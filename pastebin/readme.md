Build a Pastebin
===
**Amazon Interview Question**

What is Pastebin?
Pastebin web service enable users to store plain text over the network and generate unique URLs to access the uploaded data. It is also used to share data over the network quickly, as users would just need to pass the URL to let other users see it.

Functional Requirements:
---
- Users should be able to upload plain text called as "Pastes".
- Upon uploading the paste user should be provided unique url to access it.
- Users should only be able to upload text.
- Url's should be expired after certain period of time, if expiration time not provided by the user.

Non-Functional Requirements:
---
- System should be highly reliable i.e no data loss.
- System should be highly available i.e user should be able to access their paste most of the time.
- Minimum latency to fetch user pastes.

Scope(questions to ask interviewers)
---
- text only? yes
- users are anonymous? yes
- page view analytics? not for now
- expect how many writes/month? 10 milion
- expect how many writes/month? 100 milion
- expect to serve how long? > 3 years
- size per paste? <10000 charactors ~= 10KB


Calculation (according to the above scope)
---
- 10 milion write * 1KB = 100GB for the paste storage in a year
- 10,000,000 / (60 * 60 * 24 * 30) = 3.86 requests to write per second
- 100,000,000 / (60 * 60 * 24 * 30) = 38.6 requests to read per second

Basic Implementation
---

![](./basic.png)

To save storage, we can actually separate the paste meta data and the paste content. Save the key, created_timestamp, expiry_timestamp in Relational DB(e.g. Postgres), and save the paste content in in NoSQL Document Store(e.g. MongoDB).

For simplexity, we can, firstly, store the paste content in our MongoDB, and then use the objectID(12 charactors) generated by MongoDB as the key to store the record in Postgres, then we can use the objectID as the value for the shorturl(e.g. http://bit.ly/abcdefghiekl) and save the record into our PostgresDB

**Minimal Schema**
```sql
CREATE TABLE IF NOT EXISTS pastes (
    "id" PRIMARY KEY SERIAL, // it depends
	  "key" TEXT NOT NULL UNIQUE,
    "object_id" TEXT NOT NULL UNIQUE, // it depends
	  "created_timestamp" TIMESTAMP WITH TIME ZONE DEFAULT now(),
    "expiry_timestamp" TIMESTAMP WITH TIME ZONE,
);
```

**Minimal API Endpoints**
- Write(RESTful create)
- Read(RESTful query)

**Expiry Pastes**
- since we have saved the `expiry_timestamp` in each record, it is possbile for us to create a simple cron, e.g. very week, to set the record as inactive. 
- alternatively, to save storage, we can also delete the record and the corresponding paste content in MongoDB

**Caveats**
- please check if the objectID collides with any existing records in PostgresDB. if it collides, generate anothe objectID
- if the service supports Custom URLs, check if the user-supplied one collides with the objectID of an existing record. Prompt users to input another one if it collides
- if the interviewr thinks the url is too lengthy, [base62 hash](../tiny_url/readme.md) the incremental `id` for key(short url)
- there will be 10 folded the read than the write, it is too expensive for the server to handle the read operations

Potential Optimizations
---
- use memory cache, e.g. Redis, to handle the Read Operation such that the load to our servers can be reduced
- add a load balancer to handle tremendous number of read/write requests

![](./advanced.png)

References
---
- https://github.com/donnemartin/system-design-primer/tree/master/solutions/system_design/pastebin
- https://leetcode.com/discuss/interview-question/system-design/124804/Design-Pastebin